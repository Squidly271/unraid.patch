Menu="About"
Title="Unraid Patch"
---
<script>

function myAlert(description,textdescription,textimage,imagesize, outsideClick, showCancel, showConfirm, alertType) {
  if ( !outsideClick ) outsideClick = false;
  if ( !showCancel )   showCancel = false;
  if ( !showConfirm )  showConfirm = false;
  if ( imagesize == "" ) { imagesize = "80x80"; }
   
  swal({
    title: description,
    text: textdescription,
    imageUrl: textimage,
    imageSize: imagesize,
    allowOutsideClick: outsideClick,
    showConfirmButton: showConfirm,
    showCancelButton: showCancel,
    type: alertType,
    html: true
  });
}

function my_openBox(cmd,title,height,width,load,func) {
  // open shadowbox window (run in foreground)
  var run = cmd.split('?')[0].substr(-4)=='.php' ? cmd : '/logging.htm?cmd='+cmd+'&csrf_token=<?=$var['csrf_token']?>';
  var options = load ? {modal:false,onClose:function(){ eval(func); }} : {modal:true};
  Shadowbox.open({content:run, player:'iframe', title:title, height:height, width:width, options:options});
}


$(function() {
  caPluginUpdateCheck("unraid.patch.plg");

  <?if ( ! file_exists("/boot/config/plugins/unraid.patch/accepted") ) :?>
    swal({
      title: "_(Unraid Patch)_",
      text: '_(This plugin will automatically install any security patches issued for Unraid.  To allow, you must click accept.)_',
      html: true,
      type: 'warning',
      showCancelButton: true,
      showConfirmButton: true,
      cancelButtonText: "_(Cancel)_",
      confirmButtonText: "_(Accept)_"
      }, function (isConfirm) {
      if ( isConfirm ) {
        $.post("/plugins/unraid.patch/include/exec.php",{action:"accepted"},function(data) {
          window.location.reload();
        });
      } else {
          history.back();
      }
    }); 
  <? else: ?>
  myAlert("_(Checking For Updates)_");
  $.post("/plugins/unraid.patch/include/exec.php",{action:"check"},function(data) {
    if (data) {
      swal.close();
      if (data.trim() == "none") {
        setTimeout(function() {
          myAlert("_(No new patches found)_","_(This page will exit in 10 seconds)_");
          setTimeout(function(){
            history.back();
          },10000);
        },1000);
      } else {
        $("#display").show();
        $("#changelog").html(data);
        swal.close();
      }
    }
  })
  <?endif;?>
  });

function reload() {
  window.location.reload();
}

function install() {
  openBox("/plugins/unraid.patch/scripts/install.sh","Install Patch",550,900,true,"reload");
}
</script>
<span style='display:none;' id='display'>
<span style='font-size:2rem;'>_(These patches will be automatically installed at the next boot of your server.  You can also click the Install Now button to install it immediately)_</span>
<span id='changelog'></span>
<input type='button' value='_(Install Now)_' onclick='install();'></input>
</span>